# üöÄ MCP SQL Server: Integre o Claude Desktop ao seu Banco de Dados

> **Claude SQL Bridge**: Guia Definitivo para macOS & Windows

**√öltima atualiza√ß√£o**: Dezembro 2025  
**SQL Server testado**: Microsoft SQL Server 2025 (RTM) Enterprise Developer Edition

Este guia fornece o passo a passo para configurar o **Model Context Protocol (MCP)**, permitindo que o Claude Desktop execute consultas SQL diretamente em inst√¢ncias do **Microsoft SQL Server**.

---

## üìã √çndice

- [Pr√©-requisitos](#-pr√©-requisitos)
- [Instala√ß√£o](#-instala√ß√£o)
- [Configura√ß√£o](#-configura√ß√£o)
- [Executando Consultas](#-executando-consultas)
- [Opera√ß√µes Suportadas](#-opera√ß√µes-suportadas)
- [Limita√ß√µes](#-limita√ß√µes)
- [Permiss√µes e Seguran√ßa](#-permiss√µes-e-seguran√ßa)
- [Alternativas para Opera√ß√µes Restritas](#-alternativas-para-opera√ß√µes-restritas)
- [Troubleshooting](#-troubleshooting)
- [Contato](#-contato)

---

## üéØ Pr√©-requisitos

- **Claude Desktop** instalado
- **Node.js (v18+)** instalado
- **SQL Server** acess√≠vel (local, Docker ou remoto)
- **Porta 1433** aberta no firewall

---

## üõ†Ô∏è Instala√ß√£o

Instale o conector MCP globalmente:

```bash
npm install -g @modelcontextprotocol/server-mssql
```

> **Dica**: Use `which node` (macOS) ou `where node` (Windows) para verificar o caminho de instala√ß√£o do Node.js.

---

## ‚öôÔ∏è Configura√ß√£o

### 1. Localize o arquivo de configura√ß√£o do Claude:

- **macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
- **Windows**: `%APPDATA%\Claude\claude_desktop_config.json`

### 2. Configure o MCP Server:

```json
{
  "mcpServers": {
    "sql-server": {
      "command": "node",
      "args": [
        "C:/Users/SEU_USUARIO/AppData/Roaming/npm/node_modules/@modelcontextprotocol/server-mssql/dist/index.js"
      ],
      "env": {
        "MSSQL_CONNECTION_STRING": "Server=SEU_IP,1433;Database=NOME_BANCO;User Id=sa;Password=SUA_SENHA;Encrypt=true;TrustServerCertificate=true;"
      }
    }
  }
}
```

> **macOS**: O caminho em `args` geralmente √© `/usr/local/lib/node_modules/...`

### 3. Verifica√ß√£o de Logs:

Se o √≠cone de ferramenta (üî®) n√£o aparecer no Claude, verifique os logs:

- **macOS**: `~/Library/Logs/Claude`
- **Windows**: `%USERPROFILE%\AppData\Local\Logs\Claude`

**Arquivos principais**:
- `mcp-server-sql-server.log`: Erros de conex√£o SQL
- `claude_desktop.log`: Erros de carregamento do MCP

---

## üöÄ Executando Consultas

1. **Reinicie o Claude Desktop**
2. **Envie uma consulta**: "Mostre os top 5 produtos da tabela dbo.PRODUTOS"
3. **Autorize o acesso**: Clique em "Permitir uma vez" ou "Sempre permitir"
4. **Veja o resultado**: Dados formatados diretamente no chat

### üí° Checklist R√°pido

- ‚úÖ **Sintaxe JSON**: Verifique no VS Code se n√£o h√° erros de sintaxe
- ‚úÖ **SSL**: Use `TrustServerCertificate=true;` para SQL Server local sem certificado oficial
- ‚úÖ **Teste de rede**: 
  - macOS: `nc -zv IP 1433`
  - Windows: `Test-NetConnection IP -Port 1433`

---

## ‚úÖ Opera√ß√µes Suportadas

### Consultas e Leitura
- SELECT, JOINs complexos, subconsultas
- Consultas ao INFORMATION_SCHEMA e sys.objects
- Stored procedures de leitura
- Fun√ß√µes escalares e de tabela

### Modifica√ß√µes de Dados (DML)
- INSERT, UPDATE, DELETE, MERGE
- Transa√ß√µes (BEGIN TRANSACTION, COMMIT, ROLLBACK)

### Defini√ß√£o de Dados (DDL)
- CREATE, ALTER, DROP de tabelas, views, √≠ndices
- CREATE/ALTER stored procedures e functions
- Gerenciamento de constraints e triggers

### An√°lise e Metadata
- Consulta de estruturas de banco
- Verifica√ß√£o de estat√≠sticas e performance
- An√°lise de planos de execu√ß√£o (SET STATISTICS)

---

## ‚ùå Limita√ß√µes

### Opera√ß√µes de Arquivo (N√£o Suportadas)

- ‚ùå BACKUP DATABASE / RESTORE DATABASE (mesmo com permiss√µes)
- ‚ùå Acesso ao sistema de arquivos (xp_cmdshell, OPENROWSET)
- ‚ùå BULK INSERT de arquivos externos
- ‚ùå Importa√ß√£o/exporta√ß√£o para arquivos f√≠sicos

> **Importante**: O MCP n√£o pode executar comandos de backup porque requer acesso ao sistema de arquivos do servidor - isso √© uma limita√ß√£o da interface MCP, n√£o das permiss√µes.

### Opera√ß√µes de Sistema (Limitadas)

- ‚ùå Configura√ß√µes de servidor (sp_configure)
- ‚ùå Linked servers
- ‚ùå Replica√ß√£o e espelhamento
- ‚ùå SQL Server Agent Jobs

### Limita√ß√µes T√©cnicas

- ‚è±Ô∏è **Timeout**: 15 segundos por consulta
- üö´ **Sem transfer√™ncia de arquivos bin√°rios**
- üîå **Conex√£o**: TCP/IP na porta 1433

---

## üîê Permiss√µes e Seguran√ßa

### Verificar Permiss√µes Atuais

```sql
-- Ver todas as permiss√µes do usu√°rio
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');

-- Ver roles do usu√°rio
SELECT 
    r.name AS role_name,
    m.name AS member_name
FROM sys.database_role_members AS drm
JOIN sys.database_principals AS r ON drm.role_principal_id = r.principal_id
JOIN sys.database_principals AS m ON drm.member_principal_id = m.principal_id
WHERE m.name = USER_NAME();
```

### Roles Comuns do SQL Server

| Role | Permiss√µes Principais |
|------|----------------------|
| **db_owner** | Controle total sobre o banco |
| **db_ddladmin** | CREATE, ALTER, DROP de objetos |
| **db_datawriter** | INSERT, UPDATE, DELETE |
| **db_datareader** | SELECT em todas as tabelas |
| **db_backupoperator** | BACKUP DATABASE, BACKUP LOG |

### Exemplo: Permiss√µes com db_owner

Com a role `db_owner`, o usu√°rio possui:

**‚úÖ Opera√ß√µes de Dados**: SELECT, INSERT, UPDATE, DELETE, EXECUTE  
**‚úÖ Defini√ß√£o de Estrutura**: CREATE/ALTER/DROP de todos os objetos  
**‚úÖ Backup**: BACKUP DATABASE e BACKUP LOG (mas MCP n√£o executa)  
**‚úÖ Administra√ß√£o**: CONTROL, TAKE OWNERSHIP, VIEW DATABASE STATE  
**‚úÖ Seguran√ßa**: Gerenciar m√°scaras, classifica√ß√µes e criptografia

**Diferen√ßa importante**:
- ‚úÖ **Permiss√£o**: Usu√°rio autorizado para BACKUP DATABASE
- ‚ùå **Capacidade MCP**: Interface n√£o acessa sistema de arquivos para salvar .bak

---

## üîÑ Alternativas para Opera√ß√µes Restritas

### Backup de Dados

#### 1. Scripts SQL (Recomendado para migra√ß√£o)

```sql
-- Script completo com estrutura e dados
CREATE TABLE [dbo].[PEDIDOS](
    [ID_PEDIDO] [int] NOT NULL PRIMARY KEY,
    [ID_CLIENTE] [int] NULL,
    [VALOR_TOTAL] [numeric](18, 0) NULL
);

INSERT INTO [dbo].[PEDIDOS] VALUES (1, 1, 200);
```

**Vantagens**: Port√°vel, version√°vel no Git, funciona com MCP

#### 2. Exporta√ß√£o JSON

```sql
SELECT * FROM tabela
FOR JSON AUTO, INCLUDE_NULL_VALUES;
```

#### 3. Backup Manual (.bak)

Execute diretamente no servidor via SSMS ou Azure Data Studio:

```sql
BACKUP DATABASE [NomeDoBanco] 
TO DISK = 'C:\Backups\NomeDoBanco.bak'
WITH COMPRESSION;
```

### Outras Ferramentas

**Para grandes volumes**:
- BCP (Bulk Copy Program)
- SQL Server Import/Export Wizard
- SSIS, Azure Data Factory

---

## üìä Casos de Uso

### ‚úÖ Ideal para:
- An√°lise explorat√≥ria de dados
- Consultas ad-hoc e relat√≥rios
- Modifica√ß√µes de dados (DML)
- Cria√ß√£o e manuten√ß√£o de estruturas (DDL)
- Extra√ß√£o de dados para migra√ß√£o
- An√°lise de performance
- Prototipagem e desenvolvimento

### ‚ùå N√£o recomendado para:
- Backups bin√°rios completos
- Opera√ß√µes com sistema de arquivos
- Configura√ß√µes de servidor
- Opera√ß√µes > 15 segundos
- Agendamento de jobs

---

## üîç Troubleshooting

### Erro de Timeout
```
ERRO: Failed to connect in 15000ms
```

**Solu√ß√µes**:
- Verifique se o servidor est√° online
- Confirme que a porta 1433 est√° acess√≠vel
- Verifique configura√ß√µes de firewall
- Teste conectividade de rede

### Erro de Permiss√£o
```
The user does not have permission
```

**Solu√ß√µes**:
- Verifique permiss√µes: `SELECT * FROM fn_my_permissions(NULL, 'DATABASE')`
- Verifique roles do usu√°rio
- Solicite permiss√µes ao DBA
- Use conta com privil√©gios apropriados

### Query Lenta

**Solu√ß√µes**:
- Adicione filtros WHERE
- Use √≠ndices apropriados
- Divida query em partes menores (< 15s)
- Analise plano de execu√ß√£o: `SET STATISTICS IO, TIME ON`

---

## üí° Boas Pr√°ticas

### Migra√ß√£o de Dados
1. Use scripts SQL (mais port√°vel)
2. Teste em desenvolvimento primeiro
3. Fa√ßa backup antes de modifica√ß√µes
4. Divida opera√ß√µes grandes (< 15s)
5. Use transa√ß√µes para integridade

### Performance
1. Use √≠ndices apropriados
2. Analise planos de execu√ß√£o
3. Evite SELECT * em tabelas grandes
4. Use pagina√ß√£o para grandes resultados

### Seguran√ßa
1. Verifique permiss√µes antes de opera√ß√µes cr√≠ticas
2. Use o princ√≠pio do menor privil√©gio
3. Documente permiss√µes necess√°rias
4. Revise permiss√µes periodicamente

---

## ü§ù Contribui√ß√µes

Contribui√ß√µes s√£o bem-vindas! Reporte limita√ß√µes adicionais ou sugira melhorias.

---

## üìû Contato

**Alexandre**  
üìß alemiti@gmail.com

---
