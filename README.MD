
# üöÄ MCP SQL Server: Integre o Claude Desktop ao seu Banco de Dados
-- Claude SQL Bridge: Guia Definitivo para macOS & Windows

## √öltima atualiza√ß√£o: Dezembro 2025
## Vers√£o do SQL Server testada: Microsoft SQL Server 2025 (RTM) Enterprise Developer Edition


Este guia fornece o passo a passo unificado para configurar o **Model Context Protocol (MCP)**, permitindo que o Claude Desktop execute consultas SQL diretamente em inst√¢ncias do **Microsoft SQL Server**.

## üìã 1. Pr√©-requisitos (Ambos os Sistemas)

* **Claude Desktop** instalado.
* **Node.js (v18+)** instalado: Necess√°rio para rodar o servidor MCP.
* **SQL Server** acess√≠vel: Pode ser local, via Docker ou servidor remoto.
* **Conectividade:** Certifique-se de que a porta **1433** est√° aberta no firewall.

---

## üõ†Ô∏è 2. Instala√ß√£o do Servidor MCP

Abra o terminal (Terminal no macOS ou PowerShell/CMD no Windows) e instale o conector globalmente:

```bash
npm install -g @modelcontextprotocol/server-mssql

```

> **Dica:** Verifique o local de instala√ß√£o do Node.js com o comando `which node` (macOS) ou `where node` (Windows) para usar no arquivo de configura√ß√£o.

---

## ‚öôÔ∏è 3. Configura√ß√£o do Claude Desktop

O Claude Desktop utiliza um arquivo JSON para gerenciar os servidores. O conte√∫do √© o mesmo, mas o local do arquivo muda conforme o sistema:

### Caminho do Arquivo:

* **macOS:** `~/Library/Application Support/Claude/claude_desktop_config.json`
* **Windows:** `%APPDATA%\Claude\claude_desktop_config.json`

### Conte√∫do do JSON:

Copie e cole o c√≥digo abaixo, ajustando os caminhos de acordo com seu usu√°rio:

```json
{
  "mcpServers": {
    "sql-server": {
      "command": "node",
      "args": [
        "C:/Users/SEU_USUARIO/AppData/Roaming/npm/node_modules/@modelcontextprotocol/server-mssql/dist/index.js"
      ],
      "env": {
        "MSSQL_CONNECTION_STRING": "Server=SEU_IP,1433;Database=NOME_BANCO;User Id=sa;Password=SUA_SENHA;Encrypt=true;TrustServerCertificate=true;"
      }
    }
  }
}

```

*No **macOS**, o caminho em `args` costuma ser `/usr/local/lib/node_modules/...` ou similar.*

---

## üîç 4. Verifica√ß√£o de Logs e Troubleshooting

Se o √≠cone de ferramenta (martelo) n√£o aparecer no Claude, verifique os logs para diagnosticar erros de conex√£o ou sintaxe.

### Como abrir a pasta de logs:

* **No macOS (Terminal):**
```bash
open ~/Library/Logs/Claude

```


* **No Windows (Executar/Win+R):**
```text
%USERPROFILE%\AppData\Local\Logs\Claude

```



**Arquivos principais:**

* `mcp-server-sql-server.log`: Registra falhas de login ou erros de rede do SQL.
* `claude_desktop.log`: Registra se o Claude conseguiu carregar o Node.js e o arquivo de configura√ß√£o.

---

## üöÄ 5. Executando Consultas

1. **Reinicie o Claude Desktop:** Essencial para carregar novas configura√ß√µes.
2. **Pe√ßa uma consulta:** "Claude, mostre os top 5 produtos da tabela dbo.PRODUTOS".
3. **Autorize o Acesso:** Uma janela de seguran√ßa surgir√°. Clique em **"Permitir uma vez"** ou **"Sempre permitir"**.
4. **Resultado:** O Claude exibir√° os dados formatados em tabela diretamente no chat.

---

## üí° Dicas de Ouro (Checklist)

* **Sintaxe JSON:** No VS Code, verifique se n√£o h√° erros de "End of file expected". O arquivo deve terminar com um fechamento de chave `}` limpo.
* **Seguran√ßa SQL:** Se usar SQL Server local sem certificado SSL oficial, o par√¢metro `TrustServerCertificate=true;` na string de conex√£o √© obrigat√≥rio para evitar erros de handshake.
* **Teste de Rede:** Use `nc -zv IP 1433` (macOS) ou `Test-NetConnection IP -Port 1433` (Windows) para garantir que o banco est√° alcan√ß√°vel.

---

# Limita√ß√µes do MCP SQL Server

Este documento descreve as capacidades e limita√ß√µes do Model Context Protocol (MCP) ao conectar-se com SQL Server atrav√©s do Claude AI.

## üìã √çndice

- [Opera√ß√µes Suportadas](#opera√ß√µes-suportadas)
- [Limita√ß√µes](#limita√ß√µes)
- [Permiss√µes e Seguran√ßa](#permiss√µes-e-seguran√ßa)
- [Exemplo de An√°lise de Permiss√µes](#exemplo-de-an√°lise-de-permiss√µes)
- [Alternativas para Opera√ß√µes Restritas](#alternativas-para-opera√ß√µes-restritas)

## ‚úÖ Opera√ß√µes Suportadas

### Consultas e Leitura de Dados

- Execu√ß√£o de comandos `SELECT` em tabelas, views e fun√ß√µes
- JOINs complexos e subconsultas
- Consultas ao `INFORMATION_SCHEMA` e `sys.objects`
- Execu√ß√£o de stored procedures de leitura
- Uso de fun√ß√µes escalares e de tabela

### Modifica√ß√µes de Dados (DML)

- `INSERT`, `UPDATE`, `DELETE`
- `MERGE` e opera√ß√µes complexas de manipula√ß√£o de dados
- Gerenciamento de transa√ß√µes:
  - `BEGIN TRANSACTION`
  - `COMMIT`
  - `ROLLBACK`

### Defini√ß√£o de Dados (DDL)

- `CREATE`, `ALTER`, `DROP` de:
  - Tabelas
  - Views
  - √çndices
  - Stored procedures
  - Functions
- Gerenciamento de constraints e triggers

### An√°lise e Metadata

- Consulta de estruturas de banco de dados
- Verifica√ß√£o de estat√≠sticas e performance
- An√°lise de planos de execu√ß√£o (`SET STATISTICS`)
- Inspe√ß√£o de schemas e objetos do banco

## ‚ùå Limita√ß√µes

### 1. Opera√ß√µes de Arquivo

**N√£o suportado:**
- `BACKUP DATABASE` / `RESTORE DATABASE` ‚ö†Ô∏è (mesmo com permiss√µes adequadas)
- Acesso ao sistema de arquivos do servidor
- Comandos como `xp_cmdshell`
- `OPENROWSET` com arquivos
- Cria√ß√£o ou leitura de arquivos `.bak`, `.csv`, `.txt` no servidor
- `BULK INSERT` de arquivos externos
- Importa√ß√£o/exporta√ß√£o de dados para arquivos f√≠sicos

> **Nota Importante**: Mesmo que o usu√°rio possua as permiss√µes `BACKUP DATABASE` e `BACKUP LOG`, o MCP n√£o consegue executar comandos de backup porque eles requerem acesso ao sistema de arquivos do servidor, o que √© uma **limita√ß√£o da interface MCP**, n√£o das permiss√µes do usu√°rio.

### 2. Opera√ß√µes de Sistema

**Limitado ou n√£o suportado:**
- Gerenciamento completo de logins e usu√°rios
- Configura√ß√µes de servidor (`sp_configure`)
- Linked servers
- Replica√ß√£o e espelhamento de banco de dados
- SQL Server Agent Jobs e agendamentos

### 3. Limita√ß√µes de Rede e Performance

- **Timeout**: 15 segundos por consulta
- Sem transfer√™ncia de arquivos bin√°rios pela conex√£o
- Sem acesso direto ao sistema de arquivos do servidor
- Conex√£o TCP/IP na porta padr√£o 1433

### 4. Comandos Administrativos Avan√ßados

**Restritos:**
- Alguns comandos `DBCC` (manuten√ß√£o avan√ßada)
- Opera√ß√µes que requerem permiss√µes `sysadmin` espec√≠ficas
- Altera√ß√µes em databases de sistema (`master`, `msdb`, `model`, `tempdb`)

## üîê Permiss√µes e Seguran√ßa

As limita√ß√µes dependem das **permiss√µes do usu√°rio** configurado na conex√£o MCP.

### Verificar Permiss√µes Atuais

```sql
-- Ver todas as permiss√µes do usu√°rio atual
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');

-- Ver roles do usu√°rio
SELECT 
    r.name AS role_name,
    m.name AS member_name
FROM sys.database_role_members AS drm
JOIN sys.database_principals AS r ON drm.role_principal_id = r.principal_id
JOIN sys.database_principals AS m ON drm.member_principal_id = m.principal_id
WHERE m.name = USER_NAME();

-- Ver o usu√°rio atual
SELECT USER_NAME() AS CurrentUser, SUSER_NAME() AS CurrentLogin;
```

### Roles Comuns do SQL Server

| Role | Descri√ß√£o | Permiss√µes Principais |
|------|-----------|----------------------|
| **db_owner** | Propriet√°rio do banco | Controle total sobre o banco de dados |
| **db_ddladmin** | Administrador DDL | CREATE, ALTER, DROP de objetos |
| **db_datawriter** | Escritor de dados | INSERT, UPDATE, DELETE |
| **db_datareader** | Leitor de dados | SELECT em todas as tabelas |
| **db_backupoperator** | Operador de backup | BACKUP DATABASE, BACKUP LOG |
| **db_securityadmin** | Administrador de seguran√ßa | Gerenciar roles e permiss√µes |

### Aumentar Permiss√µes (Se Necess√°rio)

#### Para Permitir Backups via T-SQL

```sql
-- Conceder permiss√£o de backup ao usu√°rio
USE master;
GO
GRANT BACKUP DATABASE TO [seu_usuario];
GRANT BACKUP LOG TO [seu_usuario];
GO
```

#### Para Opera√ß√µes de Arquivo (‚ö†Ô∏è Risco de Seguran√ßa)

```sql
-- Habilitar xp_cmdshell (use com EXTREMA cautela!)
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```

> ‚ö†Ô∏è **Aten√ß√£o**: Habilitar `xp_cmdshell` representa riscos significativos de seguran√ßa. Use apenas em ambientes controlados e de desenvolvimento.

#### Para Opera√ß√µes DDL Completas

```sql
-- Adicionar usu√°rio ao role db_ddladmin
USE [seu_banco];
GO
ALTER ROLE db_ddladmin ADD MEMBER [seu_usuario];
GO
```

#### Para Adicionar Usu√°rio como DB Owner

```sql
-- Adicionar usu√°rio ao role db_owner (controle total)
USE [seu_banco];
GO
ALTER ROLE db_owner ADD MEMBER [seu_usuario];
GO
```

## üìä Exemplo de An√°lise de Permiss√µes

Abaixo est√° um exemplo real de an√°lise de permiss√µes de um usu√°rio com role `db_owner`:

### Informa√ß√µes do Usu√°rio

```
Role: db_owner
Usu√°rio: dbo (Database Owner)
```

### Permiss√µes Dispon√≠veis (Resumo)

**Opera√ß√µes de Dados:**
- ‚úÖ SELECT, INSERT, UPDATE, DELETE
- ‚úÖ EXECUTE (procedures e functions)
- ‚úÖ REFERENCES

**Defini√ß√£o de Estrutura:**
- ‚úÖ CREATE TABLE, VIEW, PROCEDURE, FUNCTION
- ‚úÖ CREATE SCHEMA, ROLE, USER
- ‚úÖ ALTER ANY SCHEMA, USER, ROLE
- ‚úÖ DROP (todos os objetos)

**Backup e Recupera√ß√£o:**
- ‚úÖ BACKUP DATABASE
- ‚úÖ BACKUP LOG
- ‚ö†Ô∏è Nota: Mesmo com essas permiss√µes, o MCP n√£o consegue executar comandos de backup

**Administra√ß√£o:**
- ‚úÖ ALTER (modificar banco e objetos)
- ‚úÖ CONTROL (controle total do banco)
- ‚úÖ TAKE OWNERSHIP
- ‚úÖ VIEW DATABASE STATE
- ‚úÖ KILL DATABASE CONNECTION
- ‚úÖ CHECKPOINT

**Seguran√ßa e Criptografia:**
- ‚úÖ ALTER ANY MASK / UNMASK
- ‚úÖ ALTER ANY SENSITIVITY CLASSIFICATION
- ‚úÖ VIEW ANY SENSITIVITY CLASSIFICATION
- ‚úÖ CREATE/ALTER CERTIFICATE, SYMMETRIC KEY, ASYMMETRIC KEY
- ‚úÖ VIEW ANY COLUMN ENCRYPTION KEY DEFINITION

**Recursos Avan√ßados:**
- ‚úÖ EXECUTE ANY EXTERNAL SCRIPT
- ‚úÖ ADMINISTER DATABASE BULK OPERATIONS
- ‚úÖ ALTER LEDGER (tabelas Ledger)
- ‚úÖ VIEW DATABASE PERFORMANCE STATE
- ‚úÖ CREATE/ALTER DATABASE AUDIT
- ‚úÖ SHOWPLAN (ver planos de execu√ß√£o)

### Interpreta√ß√£o

Com a role **db_owner**, o usu√°rio possui:

1. **Controle Total**: Pode executar qualquer opera√ß√£o no banco de dados
2. **Permiss√µes de Backup**: Possui `BACKUP DATABASE` e `BACKUP LOG`, mas o MCP n√£o consegue execut√°-los devido √† limita√ß√£o de acesso ao sistema de arquivos
3. **Administra√ß√£o Completa**: Pode criar, modificar e deletar qualquer objeto
4. **Seguran√ßa**: Pode gerenciar usu√°rios, roles e permiss√µes
5. **Performance**: Pode visualizar e analisar estado e performance do banco

**Diferen√ßa entre Permiss√£o e Capacidade do MCP:**
- ‚úÖ **Permiss√£o**: O usu√°rio tem autoriza√ß√£o para executar `BACKUP DATABASE`
- ‚ùå **Capacidade do MCP**: A interface MCP n√£o consegue acessar o sistema de arquivos para salvar o arquivo `.bak`

## üîÑ Alternativas para Opera√ß√µes Restritas

### Backup de Dados

Como n√£o √© poss√≠vel criar arquivos `.bak` diretamente atrav√©s do MCP, utilize estas alternativas:

#### 1. Scripts SQL de INSERT

Melhor para migra√ß√£o entre servidores diferentes:

```sql
-- Gerar script completo com estrutura e dados
-- Estrutura da tabela
CREATE TABLE [dbo].[PEDIDOS](
    [ID_PEDIDO] [int] NOT NULL PRIMARY KEY,
    [ID_CLIENTE] [int] NULL,
    [ID_PRODUTO] [int] NULL,
    [DATA_PEDIDO] [datetime] NULL,
    [DATA_ENTREGA] [date] NULL,
    [QUANTIDADE] [int] NULL,
    [VALOR_TOTAL] [numeric](18, 0) NULL
);

-- Dados
INSERT INTO [dbo].[PEDIDOS] VALUES (1, 1, 1, '2023-01-05 14:05:00', '2023-05-22', 10, 200);
-- ... mais linhas
```

**Vantagens:**
- Port√°vel entre diferentes vers√µes do SQL Server
- Version√°vel no Git
- F√°cil de revisar e modificar
- Funciona perfeitamente com o MCP

#### 2. Exporta√ß√£o para JSON

```sql
-- Exportar dados em formato JSON
SELECT * FROM tabela
FOR JSON AUTO, INCLUDE_NULL_VALUES;
```

**Vantagens:**
- Formato universal
- F√°cil de processar em outras linguagens
- Estruturado e leg√≠vel

#### 3. Gera√ß√£o de Scripts Completos do Banco

```sql
-- Listar todas as tabelas
SELECT TABLE_SCHEMA, TABLE_NAME 
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_TYPE = 'BASE TABLE';

-- Para cada tabela, gerar CREATE TABLE e INSERT statements
```

#### 4. Backup Manual no Servidor

Para backups bin√°rios completos (`.bak`), execute diretamente no servidor via SSMS, Azure Data Studio ou T-SQL:

```sql
-- Execute este comando diretamente no SQL Server (n√£o via MCP)
BACKUP DATABASE [NomeDoBanco] 
TO DISK = 'C:\Backups\NomeDoBanco.bak'
WITH FORMAT, 
     MEDIANAME = 'SQLServerBackups',
     NAME = 'Full Backup of NomeDoBanco',
     COMPRESSION;
GO

-- Verificar o backup
RESTORE VERIFYONLY 
FROM DISK = 'C:\Backups\NomeDoBanco.bak';
```

### Opera√ß√µes de Sistema

Para configura√ß√µes de sistema e jobs agendados:
- Use SQL Server Management Studio (SSMS)
- Utilize Azure Data Studio
- Acesse diretamente o servidor via RDP ou console
- Use PowerShell com m√≥dulo SqlServer

### Transfer√™ncia de Arquivos

Para importar/exportar grandes volumes de dados:
- Use BCP (Bulk Copy Program)
- Use SQL Server Import/Export Wizard
- Use ferramentas ETL como SSIS
- Use Azure Data Factory (para Azure SQL)

## üìä Casos de Uso Ideais

O MCP SQL Server √© ideal para:

- ‚úÖ An√°lise explorat√≥ria de dados
- ‚úÖ Consultas ad-hoc e relat√≥rios
- ‚úÖ Modifica√ß√µes de dados (INSERT, UPDATE, DELETE)
- ‚úÖ Cria√ß√£o e manuten√ß√£o de estruturas (DDL)
- ‚úÖ Extra√ß√£o de dados para migra√ß√£o
- ‚úÖ An√°lise de performance e otimiza√ß√£o
- ‚úÖ Gera√ß√£o de scripts de banco de dados
- ‚úÖ Verifica√ß√£o de permiss√µes e metadata
- ‚úÖ Prototipagem e desenvolvimento

## üö´ N√£o Recomendado Para

- ‚ùå Backups bin√°rios completos do banco (use SSMS ou scripts diretos)
- ‚ùå Opera√ß√µes que requerem acesso ao sistema de arquivos
- ‚ùå Configura√ß√µes avan√ßadas de servidor
- ‚ùå Gerenciamento de infraestrutura
- ‚ùå Opera√ß√µes que exigem mais de 15 segundos
- ‚ùå Importa√ß√£o/exporta√ß√£o de arquivos grandes
- ‚ùå Agendamento de jobs

## üí° Dicas e Boas Pr√°ticas

### Para Migra√ß√£o de Dados

1. **Use scripts SQL**: Mais port√°vel e version√°vel
2. **Teste em ambiente de desenvolvimento primeiro**
3. **Fa√ßa backup antes de modifica√ß√µes**: Use SSMS para criar `.bak`
4. **Divida opera√ß√µes grandes**: Evite timeout de 15 segundos
5. **Use transa√ß√µes**: Garanta integridade dos dados

### Para An√°lise de Permiss√µes

1. **Sempre verifique permiss√µes antes de opera√ß√µes cr√≠ticas**
2. **Documente as permiss√µes necess√°rias para cada opera√ß√£o**
3. **Use o princ√≠pio do menor privil√©gio**
4. **Revise permiss√µes periodicamente**

### Para Performance

1. **Use √≠ndices apropriados**
2. **Analise planos de execu√ß√£o**: Use `SET STATISTICS IO, TIME ON`
3. **Evite SELECT * em tabelas grandes**
4. **Use pagina√ß√£o para grandes resultados**

## üìù Notas Adicionais

- O MCP conecta-se via TCP/IP na porta padr√£o 1433
- Requer credenciais v√°lidas de SQL Server Authentication ou Windows Authentication
- Todas as opera√ß√µes respeitam as permiss√µes configuradas para o usu√°rio
- Transa√ß√µes s√£o suportadas e devem ser usadas para garantir integridade dos dados
- O timeout padr√£o √© de 15 segundos por consulta
- N√£o h√° limite de queries sequenciais, mas cada uma deve completar em 15 segundos

## üîç Troubleshooting

### Erro de Timeout

```
ERRO DE CONEX√ÉO: Failed to connect in 15000ms
```

**Solu√ß√µes:**
- Verifique se o servidor est√° online
- Confirme que a porta 1433 est√° acess√≠vel
- Verifique configura√ß√µes de firewall
- Teste conectividade de rede

### Erro de Permiss√£o

```
The user does not have permission to perform this action
```

**Solu√ß√µes:**
- Verifique permiss√µes com `fn_my_permissions`
- Verifique roles do usu√°rio
- Solicite permiss√µes adequadas ao DBA
- Use conta com privil√©gios apropriados

### Query Muito Lenta

**Solu√ß√µes:**
- Adicione filtros WHERE para reduzir dados
- Use √≠ndices apropriados
- Divida query em partes menores
- Analise plano de execu√ß√£o


## ü§ù Contribui√ß√µes

Sinta-se √† vontade para contribuir com este documento reportando limita√ß√µes adicionais ou sugerindo melhorias.

---


üìû Contato
Alexandre
alemiti@gmail.com
üòä

---
